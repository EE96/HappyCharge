service: serverless-test
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs14.x
  region: eu-west-2
  httpApi: 
    cors: 
      allowedOrigins: '*'
      allowedHeaders:
        - Content-Type
        - X-Amz-Date
        - Authorization
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Amz-User-Agent
        - access-token

  iam:
    role:
      statements:
        - Effect: Allow
          Action: dynamodb:GetItem
          Resource: '*'
        - Effect: Allow
          Action: dynamodb:PutItem
          Resource: "*"
        - Effect: Allow
          Action: dynamodb:UpdateItem
          Resource: "*"
        - Effect: Allow
          Action: sns:Publish
          Resource: !Ref ReportSubmittedTopic

functions:
  hello:
    handler: endpoints/handlers.hello
    events:
      - httpApi:
          path: /
          method: get
  fetchChargeDevice:
    handler: endpoints/fetchChargeDevice/lambda.handler
    events:
      - httpApi:
          path: /api/chargeDevices/{chargeDeviceId}
          method: get
  putChargeDevice:
    handler: endpoints/putChargeDevice/lambda.handler
    events: 
      - httpApi:
          path: /api/chargeDevices
          method: put
  charge:
    handler: endpoints/charge/lambda.handler
    events:
     - httpApi:
          path: /api/chargeDevices/{chargeDeviceId}/charge
          method: patch
  signUp:
    handler: endpoints/signUp/lambda.handler
    events:
      - httpApi:
          path: /api/sign-up
          method: post
  makeReport:
    handler: endpoints/makeReport/lambda.handler
    events:
      - httpApi:
          path: /api/report
          method: post
  sendReportSubmittedEmail:
    handler: endpoints/sendReportSubmittedEmail/lambda.handler
    events:
      - snsSqs:
          name: ReportSubmitted
          topicArn: !Ref ReportSubmittedTopic
          batchSize: 1

resources:
  Resources:
    Reports:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Reports
        AttributeDefinitions:
          - AttributeName: reportId
            AttributeType: S
        KeySchema:
          - AttributeName: reportId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
    ChargeDevices:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ChargeDevices
        AttributeDefinitions:
          - AttributeName: chargeDeviceId
            AttributeType: S
        KeySchema:
          - AttributeName: chargeDeviceId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 20
          WriteCapacityUnits: 20
    Users:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Users
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
    ReportSubmittedTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ReportSubmitted
	
custom:
  serverless-offline:
    httpPort: 3100
#   customDomain:
#     domainName: 'happycharge.co.uk'
#     certificateName: 'happycharge.co.uk'
#     basePath: ''

plugins:
  - serverless-plugin-typescript
  - serverless-offline
  # - serverless-domain-manager
  - "@agiledigital/serverless-sns-sqs-lambda"